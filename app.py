"""
–°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ –°–Ω–µ–≥ - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–≥–æ–≤–æ—Ä–æ–≤
–í–µ—Ä—Å–∏—è: 2.0 - –° —É–ª—É—á—à–µ–Ω–∏—è–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ù–û–í–û–ï –í v2.0:
‚úÖ Exponential backoff –¥–ª—è 529 –æ—à–∏–±–æ–∫ (5 –ø–æ–ø—ã—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 3)
‚úÖ Prompt caching –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ 90% —Å—Ç–æ–∏–º–æ—Å—Ç–∏
‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
"""

from flask import Flask, render_template, request, jsonify, send_file, session, redirect, url_for
from functools import wraps
import anthropic
from anthropic import APIError
import os
import time
import random
import json
import base64
from datetime import datetime
from pathlib import Path
import sqlite3
import re
import traceback
import logging
from io import BytesIO
from werkzeug.security import check_password_hash, generate_password_hash

# –î–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–∞–π–ª–æ–≤
from docx import Document  # –¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è DOCX
from PyPDF2 import PdfReader
from PIL import Image

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

app = Flask(__name__)
app.secret_key = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024

API_KEY = os.getenv("ANTHROPIC_API_KEY", "")
APP_PASSWORD = os.getenv("APP_PASSWORD", "sneg2025")

MODEL_HAIKU = "claude-3-5-haiku-20241022"
MODEL_SONNET = "claude-sonnet-4-20250514"

# ============================================================
# ANTHROPIC CLIENT –° –£–õ–£–ß–®–ï–ù–ù–û–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ï–ô
# ============================================================

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ retry
anthropic_client = anthropic.Anthropic(
    api_key=API_KEY,
    max_retries=5,  # –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 2 –¥–æ 5
    timeout=120.0,  # –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 60 –¥–æ 120 —Å–µ–∫—É–Ω–¥
    default_headers={
        "anthropic-beta": "prompt-caching-2024-07-31"  # –í–∫–ª—é—á–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    }
)

# ============================================================
# –§–£–ù–ö–¶–ò–Ø –° EXPONENTIAL BACKOFF
# ============================================================

def call_claude_with_retry(model, system_prompt, messages, use_caching=True, max_attempts=5):
    """
    –í—ã–∑–æ–≤ Claude API —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø—Ä–∏ 529 –æ—à–∏–±–∫–µ
    
    Args:
        model: –ú–æ–¥–µ–ª—å Claude
        system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        use_caching: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
        max_attempts: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        
    Returns:
        response: –û—Ç–≤–µ—Ç –æ—Ç Claude API
    """
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ system –ø—Ä–æ–º–ø—Ç–∞ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    if use_caching and isinstance(system_prompt, str):
        # –†–∞–∑–±–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        system_parts = [
            {
                "type": "text",
                "text": system_prompt,
                "cache_control": {"type": "ephemeral"}  # –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å
            }
        ]
    elif isinstance(system_prompt, list):
        system_parts = system_prompt
    else:
        system_parts = system_prompt
    
    for attempt in range(max_attempts):
        try:
            logger.info(f"‚Üí Claude API (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_attempts})")
            
            # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
            response = anthropic_client.messages.create(
                model=model,
                max_tokens=16000,
                system=system_parts,
                messages=messages,
                temperature=0.2
            )
            
            # –£—Å–ø–µ—à–Ω–æ!
            logger.info("‚úÖ Claude –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ")
            
            # –õ–æ–≥–∏—Ä—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
            usage = response.usage
            if hasattr(usage, 'cache_creation_input_tokens') and usage.cache_creation_input_tokens > 0:
                logger.info(f"üíæ –ö–µ—à —Å–æ–∑–¥–∞–Ω: {usage.cache_creation_input_tokens} —Ç–æ–∫–µ–Ω–æ–≤")
            if hasattr(usage, 'cache_read_input_tokens') and usage.cache_read_input_tokens > 0:
                saved = usage.cache_read_input_tokens
                logger.info(f"üí∞ –ö–µ—à –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {saved} —Ç–æ–∫–µ–Ω–æ–≤ (—ç–∫–æ–Ω–æ–º–∏—è ~90%)")
            
            return response
            
        except APIError as e:
            if e.status_code == 529:  # API Overloaded
                base_wait = 2 ** attempt
                jitter = random.uniform(0, 1)
                wait_time = base_wait + jitter
                
                logger.warning(
                    f"‚ö†Ô∏è  API –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω (529). "
                    f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_attempts}. "
                    f"–û–∂–∏–¥–∞–Ω–∏–µ {wait_time:.1f} —Å–µ–∫—É–Ω–¥..."
                )
                
                if attempt < max_attempts - 1:
                    time.sleep(wait_time)
                    continue
                else:
                    logger.error("‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã. API –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω.")
                    raise Exception(
                        "API –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. "
                        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç –∏–ª–∏ "
                        "–≤ —á–∞—Å—ã –Ω–∏–∑–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ (00:00-08:00 MSK)."
                    )
                    
            elif e.status_code == 429:  # Rate limit
                wait_time = 60
                logger.warning(f"‚ö†Ô∏è  –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (429). –û–∂–∏–¥–∞–Ω–∏–µ {wait_time} —Å–µ–∫—É–Ω–¥...")
                
                if attempt < max_attempts - 1:
                    time.sleep(wait_time)
                    continue
                else:
                    raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ API: {e.status_code} - {str(e)}")
                raise
                
        except Exception as e:
            logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
            
            if attempt < max_attempts - 1:
                wait_time = 2 ** attempt
                logger.info(f"–ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time} —Å–µ–∫—É–Ω–¥...")
                time.sleep(wait_time)
                continue
            else:
                raise

# –£–õ–£–ß–®–ï–ù–ù–´–ô –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢
SYSTEM_PROMPT = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
1. –°–û–•–†–ê–ù–Ø–ô –í–°–Æ –°–¢–†–£–ö–¢–£–†–£ - –≤—Å–µ —á–∞—Å—Ç–∏, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ä–∞–∑–¥–µ–ª—ã
2. –ü–†–ò–û–†–ò–¢–ï–¢ –î–ê–ù–ù–´–•: —Ñ–∞–π–ª—ã (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/PDF) > —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è > —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ > –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
3. –ü–†–û–í–ï–†–ö–ê –î–ê–ù–ù–´–•: –ï—Å–ª–∏ –ù–ï –•–í–ê–¢–ê–ï–¢ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Üí –≤–µ—Ä–Ω–∏ JSON —Å –≤–æ–ø—Ä–æ—Å–æ–º
4. –¢–û–ß–ù–û —Å–ª–µ–¥—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –ó–ê–ü–û–õ–ù–ï–ù–ò–ï–ú:
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã —Ñ–∞–π–ª—ã - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏–∑–≤–ª–µ–∫–∏ –∏–∑ –Ω–∏—Ö –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ü–ï–†–ï–î –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π!

–ï–°–õ–ò –ï–°–¢–¨ –ë–õ–û–ö "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í":
- –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ—á–∏—Ç–∞–π –í–ï–°–¨ —Ç–µ–∫—Å—Ç –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ
- –ù–∞–π–¥–∏ –ò–ù–ù, –ö–ü–ü, –û–ì–†–ù, –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞, –∞–¥—Ä–µ—Å, –±–∞–Ω–∫, —Å—á–µ—Ç–∞
- –ò–°–ü–û–õ–¨–ó–£–ô –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è [–†–µ–∫–≤–∏–∑–∏—Ç—ã], [–Æ—Ä. –ª–∏—Ü–æ], [–§–∞–º–∏–ª–∏—è –ò.–û.]
- –ù–ï –û–°–¢–ê–í–õ–Ø–ô [–†–µ–∫–≤–∏–∑–∏—Ç—ã] –µ—Å–ª–∏ –≤ –±–ª–æ–∫–µ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í" –µ—Å—Ç—å –ò–ù–ù, –ö–ü–ü –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã!
- –ù–ï –û–°–¢–ê–í–õ–Ø–ô [–Æ—Ä. –ª–∏—Ü–æ] –µ—Å–ª–∏ –≤ –±–ª–æ–∫–µ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–û–û–û "...", –ò–ü "...")!
- –ù–ï –û–°–¢–ê–í–õ–Ø–ô [–§–∞–º–∏–ª–∏—è –ò.–û.] –µ—Å–ª–∏ –≤ –±–ª–æ–∫–µ –µ—Å—Ç—å –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞!

–ó–∞–ø—Ä–∞—à–∏–≤–∞–π —Ç–æ–ª—å–∫–æ —Ç–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã—Ö:
1. –ù–ï–¢ –≤ –±–ª–æ–∫–µ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í"
2. –ù–ï–¢ –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
3. –ù–ï–¢ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞—Ö

–ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –±–ª–æ–∫–µ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í":
- –†–µ–∫–≤–∏–∑–∏—Ç—ã (–ò–ù–ù, –ö–ü–ü, –û–ì–†–ù, —Ä/—Å, –±–∞–Ω–∫ –∏ —Ç.–¥.)
- –§–∞–º–∏–ª–∏—è –ò.–û. –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ –±–ª–æ–∫–µ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í" ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∏ –∑–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!

–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ù–ï–¢ –ù–ò–ì–î–ï ‚Üí –≤–µ—Ä–Ω–∏ JSON:
{{
    "question": "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞",
    "missing_fields": ["—Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã—Ö —Ç–æ—á–Ω–æ –Ω–µ—Ç –Ω–∏ –≤ —Ñ–∞–π–ª–∞—Ö, –Ω–∏ –≤ —Ç–µ–∫—Å—Ç–µ"]
}}

–§–û–†–ú–ê–¢ –£–°–õ–£–ì (–°–¢–†–û–ì–û):
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–ú–µ—Ö–∞–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É–±–æ—Ä–∫–∞ —Å–Ω–µ–≥–∞ –ø–æ–≥—Ä—É–∑—á–∏–∫–æ–º ‚Äì 3000 —Ä—É–±/—á–∞—Å —Å –ù–î–° 20%. –í—ã–≤–æ–∑ —Å–Ω–µ–≥–∞ 20 –º¬≥ ‚Äì 5100 —Ä—É–±/—Ä–µ–π—Å —Å –ù–î–° 20%."
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π, –¥–≤–æ–µ—Ç–æ—á–∏–µ, –∫–æ—Ä–æ—Ç–∫–∏–π –¥–µ—Ñ–∏—Å, –º3

–ü–†–ê–í–ò–õ–ê:
- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —É—Å–ª—É–≥: ". " (—Ç–æ—á–∫–∞ + –ø—Ä–æ–±–µ–ª)
- –¢–∏—Ä–µ –º–µ–∂–¥—É –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ —Ü–µ–Ω–æ–π: " ‚Äì " (–¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
- –†–µ–≥–∏—Å—Ç—Ä: –º¬≥ (–Ω–µ –º3), –º¬≤ (–Ω–µ –º2)

–î–ê–¢–ê –ó–ê–ö–õ–Æ–ß–ï–ù–ò–Ø:
- –ò–∑–≤–ª–µ–∫–∞–π –∏–∑ –ù–û–ú–ï–†–ê –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
- –ü—Ä–∏–º–µ—Ä—ã: "20102025/1" ‚Üí "20.10.2025", "01122024/5" ‚Üí "01.12.2024"

–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ï –õ–ò–¶–û –°–û –°–¢–û–†–û–ù–´ –ó–ê–ö–ê–ó–ß–ò–ö–ê:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å: –§–ò–û + —Ç–µ–ª–µ—Ñ–æ–Ω + e-mail
- –§–û–†–ú–ê–¢ –í–°–¢–ê–í–ö–ò: "–§–ò–û —Ç–µ–ª–µ—Ñ–æ–Ω, e-mail" (–ë–ï–ó —Å–ª–æ–≤ "—Ç–µ–ª.", "e-mail:")
- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á 89123456789, ivanov@mail.ru"
- ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, —Ç–µ–ª. 89123456789, e-mail: ivanov@mail.ru"
- –ï—Å–ª–∏ –Ω–µ—Ç –≤—Å–µ—Ö —Ç—Ä—ë—Ö —á–∞—Å—Ç–µ–π ‚Üí –∑–∞–ø—Ä–æ—Å–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ï –õ–ò–¶–û –°–û –°–¢–û–†–û–ù–´ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø:
- –í—Å—Ç–∞–≤–ª—è–π –¢–û–ß–ù–û –∫–∞–∫ –¥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ç–µ–ª–µ—Ñ–æ–Ω –±–µ–∑ "—Ç–µ–ª.")
- –ù–ï –ø—Ä–æ–≤–µ—Ä—è–π –Ω–∞–ª–∏—á–∏–µ e-mail (–µ–≥–æ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å)
- –ü—Ä–∏–º–µ—Ä—ã: "89025937703" –∏–ª–∏ "–ú–∏—Ç—å–∫–∏–Ω–∞ –û.–ê. 89025937703"

E-MAIL –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ì–û –õ–ò–¶–ê (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ):
- –≠—Ç–æ e-mail –∏–∑ "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ó–ê–ö–ê–ó–ß–ò–ö–ê"
- –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂:
  * –ï—Å–ª–∏ email –∑–∞–∫–∞–∑—á–∏–∫–∞ = "mitkina.citymanage@yandex.ru" ‚Üí –æ—Å—Ç–∞–≤—å –ø–æ–ª–µ –ü–£–°–¢–´–ú
  * –ï—Å–ª–∏ email –∑–∞–∫–∞–∑—á–∏–∫–∞ ‚â† "mitkina.citymanage@yandex.ru" ‚Üí –≤—Å—Ç–∞–≤—å ", EMAIL"
- –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –°–∫–æ—Ä–∏—á–µ–Ω–∫–æ: –í–°–ï–ì–î–ê –≤—Å—Ç–∞–≤–ª—è–π ", EMAIL"
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã:
  * email = "ivanov@mail.ru" ‚Üí –≤—Å—Ç–∞–≤—å ", ivanov@mail.ru"
  * email = "mitkina.citymanage@yandex.ru" –ò –¥–æ–≥–æ–≤–æ—Ä –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ ‚Üí –æ—Å—Ç–∞–≤—å ""

–†–ï–ö–í–ò–ó–ò–¢–´ –ò–ó –§–ê–ô–õ–û–í:
- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–ï–†–í–´–ú –î–ï–õ–û–ú –∏–∑—É—á–∞–π —Ç–µ–∫—Å—Ç –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–π –∏–∑ —Ñ–∞–π–ª–æ–≤!
- –¢–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–ª–æ–∫–µ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í"
- –≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –ü–†–ò–û–†–ò–¢–ï–¢–ù–ï–ï –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ!
- –ò—â–∏ –∏ –ò–ó–í–õ–ï–ö–ê–ô –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: –ò–ù–ù, –ö–ü–ü, –û–ì–†–ù, —Ä/—Å, –±–∞–Ω–∫, –ë–ò–ö, –∫/—Å, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å, –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞
- –ù–ï –ò–ì–ù–û–†–ò–†–£–ô –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–æ–≤ - –æ–Ω–∏ —Ç–∞–º –°–ü–ï–¶–ò–ê–õ–¨–ù–û –¥–ª—è —Ç–µ–±—è –∏–∑–≤–ª–µ—á–µ–Ω—ã!
- –ï—Å–ª–∏ –≤ –±–ª–æ–∫–µ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í" –µ—Å—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –ò–•
- –ù–ï –í–´–î–£–ú–´–í–ê–ô —Ä–µ–∫–≤–∏–∑–∏—Ç—ã - —Ç–æ–ª—å–∫–æ –∏–∑ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–∞—Ö –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Üí –æ—Å—Ç–∞–≤—å [–†–µ–∫–≤–∏–∑–∏—Ç—ã], –Ω–æ –µ—Å–ª–∏ —Ñ–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ - –∏—Å–ø–æ–ª—å–∑—É–π!

–§–ê–ú–ò–õ–ò–Ø –ò.–û. –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø:
- –ò—â–∏ –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞/—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç–µ –∏–∑ –±–ª–æ–∫–∞ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í"
- –û–±—ã—á–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–æ: "–î–∏—Ä–µ–∫—Ç–æ—Ä: ...", "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä: ...", "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: ...", –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –§–ò–û –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö
- –ï—Å–ª–∏ –Ω–∞—à—ë–ª –≤ —Ñ–∞–π–ª–∞—Ö ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π
- –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–∞—Ö –Ω–µ—Ç ‚Üí –æ—Å—Ç–∞–≤—å [–§–∞–º–∏–ª–∏—è –ò.–û.]

–ê–î–†–ï–°:
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∞–¥—Ä–µ—Å–æ–≤ –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∏–∑–≤–µ—Å—Ç–µ–Ω
- –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –∞–¥—Ä–µ—Å –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ï—Å–ª–∏ –∞–¥—Ä–µ—Å–∞ –Ω–µ—Ç –≤–æ–æ–±—â–µ ‚Üí –æ—Å—Ç–∞–≤—å [–ê–¥—Ä–µ—Å]

–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –û–ë–™–ï–ö–¢–ê (–¥–ª—è –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ –£–Ω–∏–≤–µ—Ä—Å–∞–ª, –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ –ì–æ—Å, –°–∫–æ—Ä–∏—á–µ–Ω–∫–æ –ì–æ—Å):
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏–∑–≤–ª–µ–∫–∞–π –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
- –ü–†–ê–í–ò–õ–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø (–ø—Ä–æ–≤–µ—Ä—è–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
  * –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–û–∑–æ–Ω" ‚Üí –≤—Å—Ç–∞–≤—å "–û–∑–æ–Ω"
  * –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ö–ë" ‚Üí –≤—Å—Ç–∞–≤—å "–ö–ë –†–¶"
  * –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ë–∞—à–Ω–µ—Ñ—Ç—å" ‚Üí –≤—Å—Ç–∞–≤—å "–ë–∞—à–Ω–µ—Ñ—Ç—å"
  * –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ê—à–∞–Ω" ‚Üí –≤—Å—Ç–∞–≤—å "–ê—à–∞–Ω"
  * –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏" ‚Üí –≤—Å—Ç–∞–≤—å "–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏"
  * –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–õ–µ–Ω—Ç–∞" ‚Üí –≤—Å—Ç–∞–≤—å "–õ–µ–Ω—Ç–∞"
- –ò—â–∏ —ç—Ç–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
- –ï—Å–ª–∏ –Ω–µ –Ω–∞—à—ë–ª –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Üí –æ—Å—Ç–∞–≤—å [–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞]

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí –≤–µ—Ä–Ω–∏ –í–ï–°–¨ HTML –¥–æ–∫—É–º–µ–Ω—Ç (–≤—Å–µ —á–∞—Å—Ç–∏)
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ù–ï —Ö–≤–∞—Ç–∞–µ—Ç ‚Üí –≤–µ—Ä–Ω–∏ JSON —Å missing_fields
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown –±–ª–æ–∫–∏ (```html)
- –ù–∞—á–Ω–∏ —Å—Ä–∞–∑—É —Å <!DOCTYPE html> –∏–ª–∏ {{

–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_date}"""

# –°–ü–†–ê–í–û–ß–ù–ò–ö–ò
OBJECTS_DIRECTORY = {
    '–û–∑–æ–Ω –°—É—Ä–≥—É—Ç': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –≥. –°—É—Ä–≥—É—Ç, –ù–µ—Ñ—Ç–µ—é–≥–∞–Ω—Å–∫–æ–µ —à–æ—Å—Å–µ, –¥. 22/2',
    '–û–∑–æ–Ω –ù–æ—è–±—Ä—å—Å–∫': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –Ø–ù–ê–û, –≥. –ù–æ—è–±—Ä—å—Å–∫, –ø—Ä–æ–º—É–∑–µ–ª –ü–µ–ª–µ–π, 12-–π –ø—Ä–æ–µ–∑–¥, –ø–∞–Ω–µ–ª—å XIV',
    '–û–∑–æ–Ω –¢–∞–≥–∏–ª': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –≥. –ù–∏–∂–Ω–∏–π –¢–∞–≥–∏–ª, –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, –¥. 65',
    '–û–∑–æ–Ω –¢—é–º–µ–Ω—å': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –≥. –¢—é–º–µ–Ω—å, —É–ª. 30 –ª–µ—Ç –ü–æ–±–µ–¥—ã',
    '–û–∑–æ–Ω –ú–∏–∞—Å—Å': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –≥. –ú–∏–∞—Å—Å, —É–ª. 60 –ª–µ—Ç –û–∫—Ç—è–±—Ä—è, —Å—Ç—Ä. 1/1',
    '–û–∑–æ–Ω –ß–µ–ª—è–±–∏–Ω—Å–∫': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –≥. –ß–µ–ª—è–±–∏–Ω—Å–∫, —É–ª. –õ–∏–Ω–µ–π–Ω–∞—è, –¥. 59/1',
    '–û–∑–æ–Ω –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ –õ–æ–≥–æ–ø–∞—Ä–∫': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ª–æ–≥–æ–ø–∞—Ä–∫ –ö–æ–ª—å—Ü–æ–≤—Å–∫–∏–π, 15',
    '–û–∑–æ–Ω –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ –ß–µ—Ä–Ω—è—Ö–æ–≤—Å–∫–æ–≥–æ': '–û–û–û ¬´–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –†–µ—à–µ–Ω–∏—è¬ª –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, —É–ª. –ß–µ—Ä–Ω—è—Ö–æ–≤—Å–∫–æ–≥–æ, –¥. 104',
    '–õ–µ–Ω—Ç–∞ –¢–æ–ª—å—è—Ç—Ç–∏': '–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª, –≥. –¢–æ–ª—å—è—Ç—Ç–∏, —É–ª. –Æ–∂–Ω–æ–µ —à–æ—Å—Å–µ, –¥. 4',
    '–ö–ë –ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª, –≥. –ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫, —É–ª. –ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è, –¥. 132',
    '–ö–ë –ö–∞–∑–∞–Ω—å': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω, –õ–∞–∏—à–µ–≤—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω, –°—Ç–æ–ª–±–∏—â–µ–Ω—Å–∫–æ–µ —Å.–ø., —É–ª. –í–∑–ª–µ—Ç–Ω–∞—è, –¥. 28',
    '–ö–ë –ß–∏—Ç–∞': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π, –≥. –ß–∏—Ç–∞, —É–ª. –ê–≤—Ç–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–π, –¥. 10',
    '–ö–ë –ê—Ä—Ç–µ–º': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π, –ê—Ä—Ç–µ–º–æ–≤—Å–∫–∏–π –≥.–æ., –≥. –ê—Ä—Ç–µ–º, —É–ª. 2-—è –†–∞–±–æ—á–∞—è, –¥. 162, –∫–æ—Ä–ø. 3',
    '–ö–ë –ü–µ–Ω–∑–∞': '–†–¶ –û–û–û ¬´–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å¬ª –≥. –ü–µ–Ω–∑–∞, —É–ª. –ê—É—Å—Ç—Ä–∏–Ω–∞, –∑–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ 168–£',
    '–ö–ë –•–∞–±–∞—Ä–æ–≤—Å–∫': '–†–¶ –û–û–û ¬´–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å¬ª –•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π, –≥. –•–∞–±–∞—Ä–æ–≤—Å–∫, —É–ª. –®–∫–æ—Ç–æ–≤–∞, –¥. 15–ê',
    '–ö–ë –†–¶ –ü–µ—Ä–º—å': '–†–¶ –û–û–û ¬´–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å¬ª –ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π, –ü–µ—Ä–º—Å–∫–∏–π –º.–æ., –î–≤—É—Ä–µ—á–µ–Ω—Å–∫–æ–µ —Å.–ø., –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 0,99 –∫–º –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –Ω–∞ —Å–µ–≤–µ—Ä –æ—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞ –¥. –£—Å—Ç–∏–Ω–æ–≤–æ, —É–ª. –ì–µ—Ä–æ—è, –¥. 21',
    '–ö–ë –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (–°–µ—Ä–æ–≤—Å–∫–∏–π —Ç—Ä–∞–∫—Ç)': '–†–¶ –û–û–û ¬´–ê–±—Å–æ–ª—é—Ç¬ª 620000, –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª, –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –°–µ—Ä–æ–≤—Å–∫–∏–π —Ç—Ä–∞–∫—Ç 11 –∫–º, —Å—Ç—Ä. 3–ê',
    '–ö–ë –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (–û–∞–∑–∏—Å)': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ï–ö–ê–î 5 –∫–º., —Å—Ç—Ä. 6/14',
    '–ö–ë –ö–æ–ø–µ–π—Å–∫': '–û–û–û ¬´–û–∞–∑–∏—Å¬ª –ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª, –≥. –ö–æ–ø–µ–π—Å–∫, —É–ª. –õ–æ–≥–æ–ø–∞—Ä–∫–æ–≤–∞—è, –¥. 1–ê',
    '–ö–ë –ß–µ–ª—è–±–∏–Ω—Å–∫': '–†–¶ –û–û–û ¬´–ê–±—Å–æ–ª—é—Ç¬ª –ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª, –≥. –ß–µ–ª—è–±–∏–Ω—Å–∫, –ö–æ–ø–µ–π—Å–∫–æ–µ —à–æ—Å—Å–µ, –¥. 1–ü',
    '–ö–ë –£—Ñ–∞': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª 450028, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω, –≥. –£—Ñ–∞, —É–ª. –ì–≤–∞—Ä–¥–µ–π—Å–∫–∞—è, –¥. 57/1–ê –ª–∏—Ç–µ—Ä–∞ –ê1, –ø–æ–º. 172',
    '–ö–ë –û—Ä–µ–Ω–±—É—Ä–≥': '–†–¶ –û–û–û ¬´–ü—Ä–æ–º–µ—Ç–µ–π¬ª –û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª, –≥. –û—Ä–µ–Ω–±—É—Ä–≥, —É–ª. –¢–∏—Ö–∞—è, –∑–¥. 1/1',
    '–ö–ë –ò–∂–µ–≤—Å–∫': '–†–¶ –û–û–û ¬´–ü—Ä–æ–º–µ—Ç–µ–π¬ª –£–¥–º—É—Ä—Ç—Å–∫–∞—è —Ä–µ—Å–ø—É–±–ª–∏–∫–∞, –ó–∞–≤—å—è–ª–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω, —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –°–∫–ª–∞–¥—Å–∫–∞—è, –∑–¥. 1/1',
    '–ö–ë –ë–∞—Ä–Ω–∞—É–ª': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π, –≥. –ë–∞—Ä–Ω–∞—É–ª, —É–ª. –ú–∞–º–æ–Ω—Ç–æ–≤–∞, –¥. 208',
    '–ö–ë –û–º—Å–∫': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –≥. –û–º—Å–∫, —É–ª. –ê–π–≤–∞–∑–æ–≤—Å–∫–æ–≥–æ, –¥. 31',
    '–ö–ë –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': '–†–¶ –û–û–û ¬´–û–∞–∑–∏—Å¬ª –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª., –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∏–π —Ä–∞–π–æ–Ω, –¢–æ–ª–º–∞—á–µ–≤—Å–∫–∏–π —Å–µ–ª—å—Å–æ–≤–µ—Ç, –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ 3307 –∫–º, –¥. 19–ö1/1',
    '–ö–ë –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': '–†–¶ –û–û–û ¬´–ü—Ä–æ–º–µ—Ç–µ–π¬ª –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª, –≥. –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥, –ë–æ–ª—å—à–∞—è –û–∫—Ä—É–∂–Ω–∞—è 4-—è, –¥. 102, –∫–æ—Ä–ø. 1',
    '–ë–∞—à–Ω–µ—Ñ—Ç—å': '–û–û–û ¬´–ë–∞—à–Ω–µ—Ñ—Ç—å-–†–æ–∑–Ω–∏—Ü–∞¬ª',
    '–ê—à–∞–Ω': '–û–û–û ¬´–ê—à–∞–Ω¬ª',
    '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏': '–ê–û ¬´–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏¬ª'
}

ADDRESS_DIRECTORY = {
    '–û–∑–æ–Ω –°—É—Ä–≥—É—Ç': '–≥. –°—É—Ä–≥—É—Ç, –ù–µ—Ñ—Ç–µ—é–≥–∞–Ω—Å–∫–æ–µ —à., –¥. 22/2',
    '–û–∑–æ–Ω –ù–æ—è–±—Ä—å—Å–∫': '–≥. –ù–æ—è–±—Ä—å—Å–∫, –ø—Ä–æ–º—É–∑–µ–ª –ü–µ–ª–µ–π, 12-–π –ø—Ä–æ–µ–∑–¥, –ø–∞–Ω–µ–ª—å XIV',
    '–û–∑–æ–Ω –¢–∞–≥–∏–ª': '–≥. –ù–∏–∂–Ω–∏–π –¢–∞–≥–∏–ª, –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–æ–µ —à., –¥. 65',
    '–û–∑–æ–Ω –¢—é–º–µ–Ω—å': '–≥. –¢—é–º–µ–Ω—å, —É–ª. 30 –ª–µ—Ç –ü–æ–±–µ–¥—ã',
    '–û–∑–æ–Ω –ú–∏–∞—Å—Å': '–≥. –ú–∏–∞—Å—Å, —É–ª. 60 –ª–µ—Ç –û–∫—Ç—è–±—Ä—è, —Å—Ç—Ä. 1/1',
    '–û–∑–æ–Ω –ß–µ–ª—è–±–∏–Ω—Å–∫': '–≥. –ß–µ–ª—è–±–∏–Ω—Å–∫, —É–ª. –õ–∏–Ω–µ–π–Ω–∞—è, –¥. 59/1',
    '–û–∑–æ–Ω –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ –õ–æ–≥–æ–ø–∞—Ä–∫': '–≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ª–æ–≥–æ–ø–∞—Ä–∫ –ö–æ–ª—å—Ü–æ–≤—Å–∫–∏–π, 15',
    '–û–∑–æ–Ω –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ –ß–µ—Ä–Ω—è—Ö–æ–≤—Å–∫–æ–≥–æ': '–≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, —É–ª. –ß–µ—Ä–Ω—è—Ö–æ–≤—Å–∫–æ–≥–æ, –¥. 104',
    '–õ–µ–Ω—Ç–∞ –¢–æ–ª—å—è—Ç—Ç–∏': '–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª, –≥. –¢–æ–ª—å—è—Ç—Ç–∏, —É–ª. –Æ–∂–Ω–æ–µ —à–æ—Å—Å–µ, –¥. 4',
    '–ê—à–∞–Ω –ó–∞—Å–µ—á–Ω–æ–µ': '—Å. –ó–∞—Å–µ—á–Ω–æ–µ, —É–ª. –ú—è—Å–Ω–∏—Ü–∫–∞—è, –¥. 4',
    '–ê—à–∞–Ω –ü–µ–Ω–∑–∞': '–≥. –ü–µ–Ω–∑–∞, —É–ª. –ê–Ω—Ç–æ–Ω–æ–≤–∞, –¥. 78',
    '–ë–∞—à–Ω–µ—Ñ—Ç—å –ö—É—Ä–≥–∞–Ω': '–≥. –ö—É—Ä–≥–∞–Ω',
    '–ë–∞—à–Ω–µ—Ñ—Ç—å –ö—É—Ä–≥–∞–Ω 1': '–≥. –ö—É—Ä–≥–∞–Ω, –ø—Ä. –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏, –¥. 26',
    '–ë–∞—à–Ω–µ—Ñ—Ç—å –ö—É—Ä–≥–∞–Ω 2': '–≥. –ö—É—Ä–≥–∞–Ω, —É–ª. –ú–∞—à–∏–Ω–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–π, –¥. 36–ê',
}

# –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø –¢–ï–ö–°–¢–ê –ò–ó –§–ê–ô–õ–û–í
def extract_text_from_pdf(file_bytes):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ PDF"""
    try:
        pdf_reader = PdfReader(BytesIO(file_bytes))
        text = ""
        for page in pdf_reader.pages:
            text += page.extract_text() + "\n"
        return text.strip()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF: {e}")
        return ""

def extract_text_from_image(file_bytes, file_type):
    """–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é Claude - –æ–Ω —É–º–µ–µ—Ç –∏—Ö —á–∏—Ç–∞—Ç—å"""
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º None —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ Claude
    return None

def extract_text_from_docx(file_bytes):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ DOCX –≤–∫–ª—é—á–∞—è —Ç–∞–±–ª–∏—Ü—ã"""
    try:
        doc = Document(BytesIO(file_bytes))
        text_parts = []
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤
        for paragraph in doc.paragraphs:
            if paragraph.text.strip():
                text_parts.append(paragraph.text.strip())
        
        # –í–ê–ñ–ù–û: –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü!
        for table in doc.tables:
            for row in table.rows:
                row_text = []
                for cell in row.cells:
                    cell_text = cell.text.strip()
                    if cell_text:
                        row_text.append(cell_text)
                if row_text:
                    # –°–æ–µ–¥–∏–Ω—è–µ–º —è—á–µ–π–∫–∏ —á–µ—Ä–µ–∑ ": " –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                    text_parts.append(": ".join(row_text))
        
        full_text = '\n'.join(text_parts)
        return full_text.strip()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–∑ DOCX: {e}")
        return ""

CONTRACT_TYPES = {
    'city_manage_gov': {
        'name': '–î–æ–≥–æ–≤–æ—Ä –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ –ì–æ—Å',
        'parts': ['–î–æ–≥–æ–≤–æ—Ä_–°–∏—Ç–∏_–ú–µ–Ω–µ–¥–∂_–ì–æ—Å.html', '–°–ú_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_1_–ì–æ—Å.html', '–°–ú_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_2_–ì–æ—Å.html']
    },
    'city_manage_universal': {
        'name': '–î–æ–≥–æ–≤–æ—Ä –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ –£–Ω–∏–≤–µ—Ä—Å–∞–ª',
        'parts': ['–î–æ–≥–æ–≤–æ—Ä_–°–∏—Ç–∏_–ú–µ–Ω–µ–¥–∂_–£–Ω–∏–≤–µ—Ä—Å–∞–ª.html', '–°–ú_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_1_–£–Ω–∏–≤–µ—Ä—Å–∞–ª.html', '–°–ú_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_2_–£–Ω–∏–≤–µ—Ä—Å–∞–ª.html']
    },
    'city_manage_perekrestok': {
        'name': '–î–æ–≥–æ–≤–æ—Ä –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ –ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫',
        'parts': ['–î–æ–≥–æ–≤–æ—Ä_–°–∏—Ç–∏_–ú–µ–Ω–µ–¥–∂_–ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫.html', '–°–ú_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_1_–ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫.html', '–°–ú_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_2_–ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫.html']
    },
    'skorichenko_gov': {
        'name': '–î–æ–≥–æ–≤–æ—Ä –°–∫–æ—Ä–∏—á–µ–Ω–∫–æ –ì–æ—Å',
        'parts': ['–î–æ–≥–æ–≤–æ—Ä_–°–∫–æ—Ä–∏—á–µ–Ω–∫–æ_–ì–æ—Å.html', '–°–ö_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_1_–ì–æ—Å.html', '–°–ö_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_2_–ì–æ—Å.html']
    },
    'skorichenko_monetka': {
        'name': '–î–æ–≥–æ–≤–æ—Ä –°–∫–æ—Ä–∏—á–µ–Ω–∫–æ –ú–æ–Ω–µ—Ç–∫–∞',
        'parts': ['–î–æ–≥–æ–≤–æ—Ä_–°–∫–æ—Ä–∏—á–µ–Ω–∫–æ_–ú–æ–Ω–µ—Ç–∫–∞.html', '–°–ö_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_1_–ú–æ–Ω–µ—Ç–∫–∞.html', '–°–ö_–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ_2_–ú–æ–Ω–µ—Ç–∫–∞.html']
    }
}

def init_db():
    try:
        conn = sqlite3.connect('contracts_history.db')
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS contracts
                     (id INTEGER PRIMARY KEY AUTOINCREMENT,
                      contract_type TEXT NOT NULL,
                      user_data TEXT NOT NULL,
                      generated_html TEXT NOT NULL,
                      model_used TEXT NOT NULL,
                      cost_estimate REAL,
                      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
        conn.commit()
        conn.close()
        logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")

def save_to_history(contract_type, user_data, generated_html, model_used, cost_estimate):
    try:
        conn = sqlite3.connect('contracts_history.db')
        c = conn.cursor()
        c.execute('''INSERT INTO contracts (contract_type, user_data, generated_html, model_used, cost_estimate)
                     VALUES (?, ?, ?, ?, ?)''',
                  (contract_type, user_data, generated_html, model_used, cost_estimate))
        conn.commit()
        conn.close()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é: {e}")

def get_history(limit=50):
    try:
        conn = sqlite3.connect('contracts_history.db')
        c = conn.cursor()
        c.execute('''SELECT id, contract_type, user_data, created_at, model_used, cost_estimate
                     FROM contracts ORDER BY created_at DESC LIMIT ?''', (limit,))
        rows = c.fetchall()
        conn.close()
        return rows
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: {e}")
        return []

def get_contract_by_id(contract_id):
    try:
        conn = sqlite3.connect('contracts_history.db')
        c = conn.cursor()
        c.execute('SELECT * FROM contracts WHERE id = ?', (contract_id,))
        row = c.fetchone()
        conn.close()
        return row
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞: {e}")
        return None

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not session.get('logged_in'):
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        password = request.form.get('password')
        if password == APP_PASSWORD:
            session['logged_in'] = True
            return redirect(url_for('index'))
        else:
            return render_template('login.html', error='–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å')
    return render_template('login.html')

@app.route('/logout')
def logout():
    session.pop('logged_in', None)
    return redirect(url_for('login'))

@app.route('/')
@login_required
def index():
    return render_template('index.html', contract_types=CONTRACT_TYPES)

@app.route('/history')
@login_required
def history():
    contracts = get_history()
    return render_template('history.html', contracts=contracts, contract_types=CONTRACT_TYPES)

@app.route('/history/<int:contract_id>')
@login_required
def view_contract(contract_id):
    contract = get_contract_by_id(contract_id)
    if contract:
        return contract[3]
    return "–î–æ–≥–æ–≤–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω", 404

def clean_html(text):
    text = re.sub(r'```html\s*', '', text, flags=re.IGNORECASE)
    text = re.sub(r'```\s*', '', text)
    text = text.strip()
    
    patterns = [r'(<!DOCTYPE[^>]*>.*)', r'(<html[^>]*>.*)', r'(<div[^>]*>.*)']
    for pattern in patterns:
        match = re.search(pattern, text, re.DOTALL | re.IGNORECASE)
        if match:
            return match.group(1)
    
    return text

@app.route('/api/generate', methods=['POST'])
@login_required
def generate_contract():
    try:
        logger.info("=== –ù–ê–ß–ê–õ–û –ì–ï–ù–ï–†–ê–¶–ò–ò ===")
        
        data = request.json
        contract_type = data.get('contract_type')
        user_input = data.get('user_input')
        files_data = data.get('files', [])
        use_sonnet = data.get('use_sonnet', False)
        
        logger.info(f"–¢–∏–ø: {contract_type}, –ú–æ–¥–µ–ª—å: {'Sonnet' if use_sonnet else 'Haiku'}")
        logger.info(f"–î–∞–Ω–Ω—ã–µ: {len(user_input)} —Å–∏–º–≤–æ–ª–æ–≤, –§–∞–π–ª–æ–≤: {len(files_data)}")

        if not contract_type or not user_input:
            return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω —Ç–∏–ø –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ'}), 400

        if not API_KEY:
            return jsonify({'error': 'API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}), 500

        model = MODEL_SONNET if use_sonnet else MODEL_HAIKU
        templates_dir = Path('contracts_templates')
        
        logger.info(f"–ü–∞–ø–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤: {templates_dir.absolute()}")
        logger.info(f"–°—É—â–µ—Å—Ç–≤—É–µ—Ç: {templates_dir.exists()}")
        
        if not templates_dir.exists():
            logger.error(f"‚ùå –ü–∞–ø–∫–∞ contracts_templates –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
            return jsonify({'error': '–ü–∞–ø–∫–∞ —Å —à–∞–±–ª–æ–Ω–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 500
        
        contract_config = CONTRACT_TYPES.get(contract_type)
        
        if not contract_config:
            return jsonify({'error': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞'}), 400

        logger.info("–ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤...")
        template_parts = []
        for part_file in contract_config['parts']:
            template_path = templates_dir / part_file
            logger.info(f"–ò—â—É —à–∞–±–ª–æ–Ω: {template_path}")
            logger.info(f"–°—É—â–µ—Å—Ç–≤—É–µ—Ç: {template_path.exists()}")
            
            if template_path.exists():
                try:
                    with open(template_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        template_parts.append(content)
                        logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω: {part_file} ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {part_file}: {e}")
                    return jsonify({'error': f'–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ {part_file}: {str(e)}'}), 500
            else:
                logger.error(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {template_path}")
                return jsonify({'error': f'–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω: {part_file}'}), 500

        logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(template_parts)} —à–∞–±–ª–æ–Ω–æ–≤")

        current_date = datetime.now().strftime('%d.%m.%Y')
        system_prompt = SYSTEM_PROMPT.format(current_date=current_date)

        content = []

        # –§–ê–ô–õ–´ - –ò–ó–í–õ–ï–ö–ê–ï–ú –¢–ï–ö–°–¢ –ò–ó PDF –ò DOCX, –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –û–¢–ü–†–ê–í–õ–Ø–ï–ú CLAUDE
        extracted_texts = []
        images_for_claude = []  # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∏–º Claude
        
        if files_data:
            logger.info(f"=== –û–ë–†–ê–ë–û–¢–ö–ê {len(files_data)} –§–ê–ô–õ–û–í ===")
            
            for i, file_data in enumerate(files_data):
                file_type = file_data.get('type', '')
                file_name = file_data.get('name', f'file_{i+1}')
                file_bytes = base64.b64decode(file_data.get('data', ''))
                
                logger.info(f"–§–∞–π–ª {i+1}: {file_name} ({file_type})")
                
                extracted_text = ""
                
                # PDF - –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
                if 'pdf' in file_type.lower():
                    extracted_text = extract_text_from_pdf(file_bytes)
                    if extracted_text:
                        logger.info(f"‚úÖ PDF –∏–∑–≤–ª–µ—á–µ–Ω–æ {len(extracted_text)} —Å–∏–º–≤–æ–ª–æ–≤")
                        logger.info(f"–ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤: {extracted_text[:200]}")
                    else:
                        logger.warning(f"‚ö†Ô∏è PDF –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç")
                
                # DOCX/DOC - –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
                elif 'wordprocessingml' in file_type or file_name.lower().endswith(('.docx', '.doc')):
                    extracted_text = extract_text_from_docx(file_bytes)
                    if extracted_text:
                        logger.info(f"‚úÖ DOCX –∏–∑–≤–ª–µ—á–µ–Ω–æ {len(extracted_text)} —Å–∏–º–≤–æ–ª–æ–≤")
                        logger.info(f"–ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤: {extracted_text[:200]}")
                    else:
                        logger.warning(f"‚ö†Ô∏è DOCX –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç")
                
                # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º Claude
                elif 'image' in file_type.lower():
                    logger.info(f"üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ Claude –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
                    images_for_claude.append({
                        'name': file_name,
                        'type': file_type,
                        'data': file_data.get('data', '')
                    })
                
                # –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
                elif 'text' in file_type or file_name.lower().endswith('.txt'):
                    try:
                        extracted_text = file_bytes.decode('utf-8')
                        logger.info(f"‚úÖ TXT –∏–∑–≤–ª–µ—á–µ–Ω–æ {len(extracted_text)} —Å–∏–º–≤–æ–ª–æ–≤")
                    except:
                        logger.warning(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª")
                
                if extracted_text:
                    extracted_texts.append(f"=== –§–ê–ô–õ: {file_name} ===\n{extracted_text}\n")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –í–°–ï –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –≤ –Ω–∞—á–∞–ª–æ
        if extracted_texts:
            all_files_text = "\n".join(extracted_texts)
            content.append({
                'type': 'text', 
                'text': f"""{'='*80}
!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–û–ß–ò–¢–ê–ô –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û !!!
{'='*80}

–ù–∏–∂–µ –†–ï–ö–í–ò–ó–ò–¢–´ –ò –î–ê–ù–ù–´–ï –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –∏–∑ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
–≠—Ç–æ –ù–ï –ø—Ä–∏–º–µ—Ä! –≠—Ç–æ –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –î–û–õ–ñ–ï–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å!

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–π–¥–∏ –≤ —ç—Ç–æ–º —Ç–µ–∫—Å—Ç–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π:
- –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–û–û–û "...", –ê–û "...", –ò–ü "...")
- –ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)
- –ö–ü–ü (9 —Ü–∏—Ñ—Ä)
- –û–ì–†–ù (13 –∏–ª–∏ 15 —Ü–∏—Ñ—Ä)
- –†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç (20 —Ü–∏—Ñ—Ä)
- –ë–∞–Ω–∫ (–Ω–∞–∑–≤–∞–Ω–∏–µ)
- –ë–ò–ö (9 —Ü–∏—Ñ—Ä)
- –ö–æ—Ä—Ä. —Å—á—ë—Ç (20 —Ü–∏—Ñ—Ä)
- –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ (–ò–≤–∞–Ω–æ–≤ –ò.–ò., –ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á –∏ —Ç.–¥.)
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å

–ï—Å–ª–∏ —Ç—ã –ù–ï –ù–ê–ô–î–Å–®–¨ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ - –∑–Ω–∞—á–∏—Ç —Ç—ã –ø–ª–æ—Ö–æ –∏—Å–∫–∞–ª!
–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¢–û–ß–ù–û –ï–°–¢–¨ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–∏–∂–µ - –Ω–∞–π–¥–∏ –∏—Ö!

{'='*80}
–ù–ê–ß–ê–õ–û –î–ê–ù–ù–´–• –ò–ó –§–ê–ô–õ–û–í:
{'='*80}

{all_files_text}

{'='*80}
–ö–û–ù–ï–¶ –î–ê–ù–ù–´–• –ò–ó –§–ê–ô–õ–û–í
{'='*80}

–¢–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–∏ –¥–æ–≥–æ–≤–æ—Ä –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ!
–ù–ï –û–°–¢–ê–í–õ–Ø–ô [–†–µ–∫–≤–∏–∑–∏—Ç—ã], [–Æ—Ä. –ª–∏—Ü–æ], [–§–∞–º–∏–ª–∏—è –ò.–û.] - –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –≤—ã—à–µ!"""
            })
            logger.info(f"‚úÖ –í—Å–µ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–æ —Ç–µ–∫—Å—Ç–∞ –∏–∑ {len(extracted_texts)} —Ñ–∞–π–ª–æ–≤: {len(all_files_text)} —Å–∏–º–≤–æ–ª–æ–≤")
            logger.info(f"üìã –í–ï–°–¨ –ò–ó–í–õ–ï–ß–Å–ù–ù–´–ô –¢–ï–ö–°–¢:\n{all_files_text}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è Claude
        if images_for_claude:
            content.append({'type': 'text', 'text': f"\n{'='*80}\n–ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ({len(images_for_claude)} —à—Ç) - –ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç —Å –Ω–∏—Ö:\n{'='*80}\n"})
            for img in images_for_claude:
                content.append({'type': 'text', 'text': f"–§–∞–π–ª: {img['name']}"})
                content.append({
                    'type': 'image',
                    'source': {'type': 'base64', 'media_type': img['type'], 'data': img['data']}
                })
            logger.info(f"üì∑ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {len(images_for_claude)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π Claude –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
        
        if not extracted_texts and not images_for_claude:
            logger.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –Ω–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞")

        # –®–ê–ë–õ–û–ù–´
        template_text = ""
        for i, part in enumerate(template_parts):
            template_text += f"\n\n{'='*80}\n–ß–ê–°–¢–¨ {i+1}/{len(template_parts)}: {contract_config['parts'][i]}\n{'='*80}\n\n{part}"
        
        objects_ref = json.dumps(OBJECTS_DIRECTORY, ensure_ascii=False, indent=2)
        addresses_ref = json.dumps(ADDRESS_DIRECTORY, ensure_ascii=False, indent=2)
        
        user_message = f"""–ó–ê–î–ê–ß–ê: –ó–∞–ø–æ–ª–Ω–∏ –í–°–ï {len(template_parts)} —á–∞—Å—Ç–∏ —à–∞–±–ª–æ–Ω–∞ –ò–õ–ò –≤–µ—Ä–Ω–∏ JSON –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö.

{'='*80}
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í:
{'='*80}
{"‚úÖ –í—ã—à–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç—ã –£–ñ–ï –ü–û–õ–£–ß–ò–õ —Ç–µ–∫—Å—Ç –∏–∑ " + str(len(extracted_texts)) + " —Ñ–∞–π–ª–æ–≤!" if extracted_texts else "‚ö†Ô∏è –§–∞–π–ª—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ —Ç–µ–∫—Å—Ç–∞"}
{"‚úÖ –í—ã—à–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç—ã –£–ñ–ï –ü–û–õ–£–ß–ò–õ " + str(len(images_for_claude)) + " –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞!" if images_for_claude else ""}

–ü–†–ò–û–†–ò–¢–ï–¢ –î–ê–ù–ù–´–•:
1. –î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í (–≤ –±–ª–æ–∫–µ "–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í" –≤—ã—à–µ) - –°–ê–ú–´–ô –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢!
2. –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∏–∂–µ
3. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
4. –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ

{"‚ö†Ô∏è –ù–ï –ò–ì–ù–û–†–ò–†–£–ô –±–ª–æ–∫ '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í' - —Ç–∞–º —Ä–µ–∫–≤–∏–∑–∏—Ç—ã!" if extracted_texts else ""}
{"‚ö†Ô∏è –ù–ï –ò–ì–ù–û–†–ò–†–£–ô –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –ø—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç —Å –Ω–∏—Ö!" if images_for_claude else ""}

–ù–ï –ó–ê–ü–†–ê–®–ò–í–ê–ô —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ, —á—Ç–æ –£–ñ–ï –ï–°–¢–¨ –≤ —Ñ–∞–π–ª–∞—Ö!

{'='*80}
{'='*80}
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ü–ï–†–ï–î –ó–ê–ü–û–õ–ù–ï–ù–ò–ï–ú –®–ê–ë–õ–û–ù–ê ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
{'='*80}
{"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ï–†–ù–ò–°–¨ –ö –ë–õ–û–ö–£ '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í' –í–´–®–ï!" if extracted_texts else ""}
{"–ù–∞–π–¥–∏ —Ç–∞–º –ò–ù–ù, –ö–ü–ü, –û–ì–†–ù, –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞!" if extracted_texts else ""}
{"–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è [–†–µ–∫–≤–∏–∑–∏—Ç—ã], [–Æ—Ä. –ª–∏—Ü–æ], [–§–∞–º–∏–ª–∏—è –ò.–û.]!" if extracted_texts else ""}
{"–ù–ï –û–°–¢–ê–í–õ–Ø–ô —ç—Ç–∏ –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏ - –¥–∞–Ω–Ω—ã–µ –ï–°–¢–¨ –≤ –±–ª–æ–∫–µ '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í'!" if extracted_texts else ""}
{'='*80}
{'='*80}

–®–ê–ë–õ–û–ù–´ (–≤—Å–µ —á–∞—Å—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä–∞):
{'='*80}
{template_text}

{'='*80}
–î–ê–ù–ù–´–ï –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{'='*80}
{user_input}

{'='*80}
–°–ü–†–ê–í–û–ß–ù–ò–ö–ò:
{'='*80}
–û–±—ä–µ–∫—Ç—ã: {objects_ref}
–ê–¥—Ä–µ—Å–∞: {addresses_ref}

{'='*80}
–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø:
{'='*80}

1. –î–ê–¢–ê –ó–ê–ö–õ–Æ–ß–ï–ù–ò–Ø [–î–∞—Ç–∞ –∑–∞–∫–ª—é—á–µ–Ω–∏—è]:
   - –ò–∑–≤–ª–µ–∫–∞–π –∏–∑ –ù–û–ú–ï–†–ê –¥–æ–≥–æ–≤–æ—Ä–∞
   - –§–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì
   - –ü—Ä–∏–º–µ—Ä: "20102025/1" ‚Üí "20.10.2025"

2. –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ï –õ–ò–¶–û –°–û –°–¢–û–†–û–ù–´ –ó–ê–ö–ê–ó–ß–ò–ö–ê [–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ª–∏—Ü–æ —Å —Å—Ç–æ—Ä–æ–Ω—ã –∑–∞–∫–∞–∑—á–∏–∫–∞]:
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –§–ò–û + —Ç–µ–ª–µ—Ñ–æ–Ω + e-mail
   - –§–û–†–ú–ê–¢: "–§–ò–û —Ç–µ–ª–µ—Ñ–æ–Ω, e-mail" (–ë–ï–ó —Å–ª–æ–≤ "—Ç–µ–ª." –∏–ª–∏ "e-mail:")
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: "–ê–ª—ë—à–∏–Ω–∞ –ú–∞—Ä–∏–Ω–∞ –ê–Ω–¥—Ä–µ–µ–≤–Ω–∞ 89193776442, aleshina-marina.1998@yandex.ru"
   - ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: "–ê–ª—ë—à–∏–Ω–∞ –ú–∞—Ä–∏–Ω–∞ –ê–Ω–¥—Ä–µ–µ–≤–Ω–∞, —Ç–µ–ª. 89193776442, e-mail: aleshina-marina.1998@yandex.ru"
   - –ï—Å–ª–∏ –Ω–µ—Ç –≤—Å–µ—Ö 3 —á–∞—Å—Ç–µ–π ‚Üí –≤–µ—Ä–Ω–∏ JSON —Å missing_fields

3. –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ï –õ–ò–¶–û –°–û –°–¢–û–†–û–ù–´ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø [–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ª–∏—Ü–æ —Å —Å—Ç–æ—Ä–æ–Ω—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è]:
   - –í—Å—Ç–∞–≤–ª—è–π –¢–û–ß–ù–û –∫–∞–∫ –¥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤)
   - –ü—Ä–∏–º–µ—Ä: "89025937703" ‚Üí –≤—Å—Ç–∞–≤—å "89025937703"
   - –ù–ï –ø—Ä–æ–≤–µ—Ä—è–π –Ω–∞–ª–∏—á–∏–µ e-mail (–µ–≥–æ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å)

4. E-MAIL –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ì–û [E-mail –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ]:
   - –≠—Ç–æ e-mail –∏–∑ "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª–∏—Ü–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ó–ê–ö–ê–ó–ß–ò–ö–ê"
   - –î–õ–Ø –°–ò–¢–ò –ú–ï–ù–ï–î–ñ:
     * –ï—Å–ª–∏ email –∑–∞–∫–∞–∑—á–∏–∫–∞ = "mitkina.citymanage@yandex.ru" ‚Üí –æ—Å—Ç–∞–≤—å –ø–æ–ª–µ –ü–£–°–¢–´–ú
     * –ï—Å–ª–∏ email –∑–∞–∫–∞–∑—á–∏–∫–∞ ‚â† "mitkina.citymanage@yandex.ru" ‚Üí –≤—Å—Ç–∞–≤—å ", EMAIL"
   - –î–õ–Ø –°–ö–û–†–ò–ß–ï–ù–ö–û: –í–°–ï–ì–î–ê –≤—Å—Ç–∞–≤–ª—è–π ", EMAIL"
   - –ü—Ä–∏–º–µ—Ä—ã:
     * email –∑–∞–∫–∞–∑—á–∏–∫–∞ = "aleshina-marina.1998@yandex.ru" ‚Üí –≤—Å—Ç–∞–≤—å ", aleshina-marina.1998@yandex.ru"
     * email –∑–∞–∫–∞–∑—á–∏–∫–∞ = "mitkina.citymanage@yandex.ru" –ò –°–∏—Ç–∏ –ú–µ–Ω–µ–¥–∂ ‚Üí –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º

5. –†–ï–ö–í–ò–ó–ò–¢–´ [–†–µ–∫–≤–∏–∑–∏—Ç—ã]:
   - {"‚úÖ –ï–°–¢–¨ –ë–õ–û–ö '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í' –≤—ã—à–µ - –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ!" if extracted_texts else "‚ö†Ô∏è –§–∞–π–ª—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ–∫—Å—Ç–∞"}
   - {"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–π–¥–∏ –≤ –±–ª–æ–∫–µ '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í' –∏ –≤—Å—Ç–∞–≤—å:" if extracted_texts else "–ò—â–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"}
     * –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: –û–û–û "...", –ê–û "...", –ò–ü "..."
     * –ò–ù–ù: 10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: 6674445566)
     * –ö–ü–ü: 9 —Ü–∏—Ñ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: 667401001)
     * –û–ì–†–ù: 13-15 —Ü–∏—Ñ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1166658123456)
     * –†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç: 20 —Ü–∏—Ñ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: 40702810300000123456)
     * –ë–∞–Ω–∫: –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫)
     * –ë–ò–ö: 9 —Ü–∏—Ñ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: 046577674)
     * –ö–æ—Ä—Ä. —Å—á—ë—Ç: 20 —Ü–∏—Ñ—Ä
     * –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
   - {"–ù–ï –û–°–¢–ê–í–õ–Ø–ô [–†–µ–∫–≤–∏–∑–∏—Ç—ã] - –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–ª–æ–∫–∞ '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í'!" if extracted_texts else "–ï—Å–ª–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –Ω–µ—Ç ‚Üí –æ—Å—Ç–∞–≤—å [–†–µ–∫–≤–∏–∑–∏—Ç—ã]"}

6. –§–ê–ú–ò–õ–ò–Ø –ò.–û. –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø [–§–∞–º–∏–ª–∏—è –ò.–û.]:
   - {"‚úÖ –ò–©–ò–¢–ï –≤ –±–ª–æ–∫–µ '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í' –≤—ã—à–µ!" if extracted_texts else "–ò—â–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"}
   - –ò—â–∏ –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞: "–î–∏—Ä–µ–∫—Ç–æ—Ä: –ò–≤–∞–Ω–æ–≤ –ò.–ò.", "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á"
   - –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –§–ò–û –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö
   - {"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–π–¥–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –§–ò–û –∏–∑ –±–ª–æ–∫–∞ '–î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–û–í'!" if extracted_texts else "–ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –æ—Å—Ç–∞–≤—å [–§–∞–º–∏–ª–∏—è –ò.–û.]"}
   - {"–ù–ï –û–°–¢–ê–í–õ–Ø–ô [–§–∞–º–∏–ª–∏—è –ò.–û.] - –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ —Ñ–∞–π–ª–∞—Ö!" if extracted_texts else ""}

6.1. –Æ–†–ò–î–ò–ß–ï–°–ö–û–ï –õ–ò–¶–û [–Æ—Ä. –ª–∏—Ü–æ]:
   - –î–ª—è –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ô (–û–û–û, –ò–ü, –ê–û –∏ —Ç.–¥.):
     * –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * –§–æ—Ä–º–∞—Ç: "–û–û–û ¬´–ù–∞–∑–≤–∞–Ω–∏–µ¬ª", "–ò–ü –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
   
   - –î–ª—è –°–ê–ú–û–ó–ê–ù–Ø–¢–´–•:
     * –ï–°–õ–ò –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–ª–æ–≤–æ "—Å–∞–º–æ–∑–∞–Ω—è—Ç—ã–π" 
     * –ò–õ–ò –ï–°–õ–ò –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ä–º–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ (–Ω–µ—Ç –û–û–û, –ò–ü, –ê–û –∏ —Ç.–¥.)
     * –¢–û –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç:
     
     "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω –†–§ [–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ], —è–≤–ª—è—é—â–∏–π—Å—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–º –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Å–ø—Ä–∞–≤–∫–∏ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç [–¥–∞—Ç–∞ —Å–ø—Ä–∞–≤–∫–∏] ‚Ññ [–Ω–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∫–∏], (–ø–∞—Å–ø–æ—Ä—Ç: [—Å–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞], [–∫–µ–º –≤—ã–¥–∞–Ω] [–¥–∞—Ç–∞ –≤—ã–¥–∞—á–∏], –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: [–∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏])"
     
     * –ì–¥–µ:
       - [–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ] - –§–ò–û —Å–∞–º–æ–∑–∞–Ω—è—Ç–æ–≥–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
       - [–¥–∞—Ç–∞ —Å–ø—Ä–∞–≤–∫–∏] - –¥–∞—Ç–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
       - [–Ω–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∫–∏] - –Ω–æ–º–µ—Ä –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
       - [—Å–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞] - –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
       - [–∫–µ–º –≤—ã–¥–∞–Ω] - –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
       - [–¥–∞—Ç–∞ –≤—ã–¥–∞—á–∏] - –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
       - [–∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏] - –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
     
     * –ï—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –æ—Å—Ç–∞–≤—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö
     * –ü—Ä–∏–º–µ—Ä: "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω –†–§ –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, —è–≤–ª—è—é—â–∏–π—Å—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–º –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Å–ø—Ä–∞–≤–∫–∏ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç 15.03.2024 ‚Ññ 12345, (–ø–∞—Å–ø–æ—Ä—Ç: 4512 123456, –≤—ã–¥–∞–Ω –û–í–î –õ–µ–Ω–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞ 10.05.2010, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10, –∫–≤. 5)"

7. –ê–î–†–ï–° [–ê–¥—Ä–µ—Å]:
7. –ê–î–†–ï–° [–ê–¥—Ä–µ—Å]:
   - –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∞–¥—Ä–µ—Å–æ–≤ –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∏–∑–≤–µ—Å—Ç–µ–Ω
   - –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –∞–¥—Ä–µ—Å –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ï—Å–ª–∏ –∞–¥—Ä–µ—Å–∞ –Ω–µ—Ç –≤–æ–æ–±—â–µ ‚Üí –æ—Å—Ç–∞–≤—å [–ê–¥—Ä–µ—Å]

8. –ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï –û–ë–™–ï–ö–¢–ê [–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞] (–¥–ª—è –£–Ω–∏–≤–µ—Ä—Å–∞–ª, –ì–æ—Å):
   - –ò—â–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
   - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–û–∑–æ–Ω" ‚Üí "–û–∑–æ–Ω"
   - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ö–ë" ‚Üí "–ö–ë –†–¶"
   - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ë–∞—à–Ω–µ—Ñ—Ç—å" ‚Üí "–ë–∞—à–Ω–µ—Ñ—Ç—å"
   - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ê—à–∞–Ω" ‚Üí "–ê—à–∞–Ω"
   - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏" ‚Üí "–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏"
   - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–õ–µ–Ω—Ç–∞" ‚Üí "–õ–µ–Ω—Ç–∞"
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞—à—ë–ª ‚Üí [–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞]

9. –£–°–õ–£–ì–ò [–£—Å–ª—É–≥–∏]:
   - –§–æ—Ä–º–∞—Ç: "–ù–∞–∑–≤–∞–Ω–∏–µ ‚Äì —Ü–µ–Ω–∞. " (–¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏, —Ç–æ—á–∫–∞ –≤ –∫–æ–Ω—Ü–µ)
   - –º¬≥ (–Ω–µ –º3), –º¬≤ (–Ω–µ –º2)

10. –§–û–†–ú–ê [–§–æ—Ä–º–∞]:
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:
   
   –ï–°–õ–ò –û–û–û:
   ‚Üí "–û–û–û ¬´–ù–∞–∑–≤–∞–Ω–∏–µ¬ª"
   ‚Üí –ü—Ä–∏–º–µ—Ä: "–û–û–û ¬´–°—Ç–∏–º—É–ª¬ª"
   
   –ï–°–õ–ò –ò–ü:
   ‚Üí "–ò–ü –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"
   ‚Üí –ü—Ä–∏–º–µ—Ä: "–ò–ü –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
   
   –ï–°–õ–ò –°–ê–ú–û–ó–ê–ù–Ø–¢–´–ô:
   ‚Üí –û–°–¢–ê–í–ò–¢–¨ –ü–û–õ–ï –ü–£–°–¢–´–ú (–Ω–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å)
   ‚Üí –°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è: –µ—Å—Ç—å —Å–ª–æ–≤–æ "—Å–∞–º–æ–∑–∞–Ω—è—Ç—ã–π" –ò–õ–ò –Ω–µ—Ç –û–û–û/–ò–ü –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö
   
   –ï–°–õ–ò —Ñ–æ—Ä–º–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞:
   ‚Üí –û—Å—Ç–∞–≤–∏—Ç—å [–§–æ—Ä–º–∞]

11. –í–ò–î –£–°–õ–£–ì [–í–∏–¥ —É—Å–ª—É–≥]:
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ–º –ø–∞–¥–µ–∂–µ (—á—Ç–æ? –∫—Ç–æ?)
   
   ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
   - "–£–±–æ—Ä–∫–∞ —Å–Ω–µ–≥–∞"
   - "–ü–æ–≥—Ä—É–∑–æ—á–Ω–æ-—Ä–∞–∑–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
   - "–í—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞"
   - "–ú–µ—Ö–∞–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É–±–æ—Ä–∫–∞"
   
   ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:
   - "—É–±–æ—Ä–∫–∞ —Å–Ω–µ–≥–∞" (—Å—Ç—Ä–æ—á–Ω–∞—è –±—É–∫–≤–∞)
   - "—É–±–æ—Ä–∫–µ —Å–Ω–µ–≥–∞" (—Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂)
   - "–ø–æ–≥—Ä—É–∑–æ—á–Ω–æ-—Ä–∞–∑–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ä–∞–±–æ—Ç" (—Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂)
   
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª –≤ –¥—Ä—É–≥–æ–º –ø–∞–¥–µ–∂–µ ‚Üí –ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π
   - –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:
     * "—É–±–æ—Ä–∫–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏" ‚Üí "–£–±–æ—Ä–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏"
     * "–≤—ã–≤–æ–∑–∞ –º—É—Å–æ—Ä–∞" ‚Üí "–í—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞"
     * "–º–µ—Ö–∞–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —É–±–æ—Ä–∫–∏" ‚Üí "–ú–µ—Ö–∞–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É–±–æ—Ä–∫–∞"

{'='*80}
–ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô:
{'='*80}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã —Ñ–∞–π–ª—ã ({len(files_data)} —à—Ç.) ‚Üí –°–ù–ê–ß–ê–õ–ê –∏–∑–≤–ª–µ–∫–∏ –∏–∑ –Ω–∏—Ö –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ù–ï –ó–ê–ü–†–ê–®–ò–í–ê–ô: –†–µ–∫–≤–∏–∑–∏—Ç—ã, –§–∞–º–∏–ª–∏—è –ò.–û., –Æ—Ä. –ª–∏—Ü–æ - –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –µ—Å—Ç—å
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–π —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã—Ö —Ç–æ—á–Ω–æ –Ω–µ—Ç –Ω–∏ –≤ —Ñ–∞–π–ª–∞—Ö, –Ω–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ï–°–õ–ò –ü–†–ò–ö–†–ï–ü–õ–ï–ù–´ –§–ê–ô–õ–´:
‚Üí –ò–∑–≤–ª–µ–∫–∏ –º–∞–∫—Å–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö
‚Üí –ó–∞–ø–æ–ª–Ω–∏ —á—Ç–æ –º–æ–∂–µ—à—å
‚Üí –û—Å—Ç–∞–≤—å [–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã] –¥–ª—è —Ç–æ–≥–æ —á–µ–≥–æ –Ω–µ –Ω–∞—à—ë–ª
‚Üí –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π JSON —Å missing_fields –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–æ–≤

–ï–°–õ–ò –ù–ï–¢ –§–ê–ô–õ–û–í –ò –ù–ï–¢ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –î–ê–ù–ù–´–• –í –¢–ï–ö–°–¢–ï ‚Üí –≤–µ—Ä–Ω–∏ JSON:
{{{{
    "question": "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞",
    "missing_fields": ["—Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã—Ö —Ç–æ—á–Ω–æ –Ω–µ—Ç –Ω–∏ –≤ —Ñ–∞–π–ª–∞—Ö, –Ω–∏ –≤ —Ç–µ–∫—Å—Ç–µ"]
}}}}

–ï–°–õ–ò –í–°–Å –ï–°–¢–¨ –ò–õ–ò –§–ê–ô–õ–´ –ü–†–ò–ö–†–ï–ü–õ–ï–ù–´ ‚Üí –≤–µ—Ä–Ω–∏ –í–ï–°–¨ HTML –¥–æ–∫—É–º–µ–Ω—Ç ({len(template_parts)} —á–∞—Å—Ç–∏) –ë–ï–ó markdown.
–ù–∞—á–Ω–∏ —Å—Ä–∞–∑—É —Å <!DOCTYPE html>"""

        content.append({'type': 'text', 'text': user_message})

        logger.info("‚Üí Claude API")
        
        try:
            messages = [{'role': 'user', 'content': content}]

            # –ù–û–í–´–ô –í–´–ó–û–í –° RETRY –ò –ö–ï–®–ò–†–û–í–ê–ù–ò–ï–ú
            response = call_claude_with_retry(
                model=model,
                system_prompt=system_prompt,
                messages=messages,
                use_caching=True,  # –í–∫–ª—é—á–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
                max_attempts=5
            )

            logger.info("‚Üê –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω")
            
            assistant_response = response.content[0].text
            input_tokens = response.usage.input_tokens
            output_tokens = response.usage.output_tokens
            
            if model == MODEL_HAIKU:
                cost = (input_tokens * 0.25 + output_tokens * 1.25) / 1000000
            else:
                cost = (input_tokens * 3 + output_tokens * 15) / 1000000

            logger.info(f"–¢–æ–∫–µ–Ω—ã: {input_tokens}/{output_tokens}, –¶–µ–Ω–∞: ${cost:.4f}")

            if assistant_response.strip().startswith('{'):
                try:
                    json_data = json.loads(assistant_response)
                    if 'question' in json_data:
                        return jsonify({
                            'status': 'question',
                            'question': json_data['question'],
                            'missing_fields': json_data.get('missing_fields', []),
                            'conversation': messages + [{'role': 'assistant', 'content': assistant_response}],
                            'cost': round(cost, 4)
                        })
                except:
                    pass

            clean_html_text = clean_html(assistant_response)

            if len(clean_html_text) < 1000:
                return jsonify({'error': '–û—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', 'debug': assistant_response[:500]}), 500

            # –°–û–•–†–ê–ù–Ø–ï–ú –î–û–ì–û–í–û–† –°–†–ê–ó–£ (–¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ –ø–æ–ª—è)
            save_to_history(contract_type, user_input, clean_html_text, model, cost)
            
            # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞
            conn = sqlite3.connect('contracts_history.db')
            c = conn.cursor()
            c.execute('SELECT last_insert_rowid()')
            contract_id = c.fetchone()[0]
            conn.close()

            # –ü–†–û–í–ï–†–ö–ê: –û—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã?
            critical_placeholders = []
            if '[–†–µ–∫–≤–∏–∑–∏—Ç—ã]' in clean_html_text:
                critical_placeholders.append('–†–µ–∫–≤–∏–∑–∏—Ç—ã')
            if '[–Æ—Ä. –ª–∏—Ü–æ]' in clean_html_text or '[–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ]' in clean_html_text:
                critical_placeholders.append('–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ')
            if '[–§–∞–º–∏–ª–∏—è –ò.–û.]' in clean_html_text or '[–§–∞–º–∏–ª–∏—è –ò.–û. –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è]' in clean_html_text:
                critical_placeholders.append('–§–∞–º–∏–ª–∏—è –ò.–û. –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è')
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            if critical_placeholders:
                logger.warning(f"‚ö†Ô∏è –ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: {critical_placeholders}")
                return jsonify({
                    'status': 'warning',  # –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    'html': clean_html_text,  # –í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTML
                    'contract_id': contract_id,  # ID –µ—Å—Ç—å - –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å
                    'question': f"‚ö†Ô∏è –î–æ–≥–æ–≤–æ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö",
                    'missing_fields': critical_placeholders,
                    'conversation': messages + [{'role': 'assistant', 'content': assistant_response}],
                    'cost': round(cost, 4),
                    'model': model,
                    'tokens': {'input': input_tokens, 'output': output_tokens}
                })

            logger.info("=== –£–°–ü–ï–®–ù–û ===")
            return jsonify({
                'status': 'success',
                'html': clean_html_text,
                'contract_id': contract_id,
                'cost': round(cost, 4),
                'model': model,
                'tokens': {'input': input_tokens, 'output': output_tokens}
            })

        except anthropic.AuthenticationError as e:
            return jsonify({'error': f'–û—à–∏–±–∫–∞ API –∫–ª—é—á–∞: {str(e)}'}), 500
        except anthropic.APIError as e:
            return jsonify({'error': f'–û—à–∏–±–∫–∞ API: {str(e)}'}), 500

    except Exception as e:
        logger.error(f"–û–®–ò–ë–ö–ê: {e}")
        logger.error(traceback.format_exc())
        return jsonify({'error': f'–û—à–∏–±–∫–∞: {str(e)}'}), 500

init_db()

if __name__ == '__main__':
    port = int(os.getenv('PORT', 5000))
    logger.info(f"–ü–æ—Ä—Ç: {port}, API: {'–î–∞' if API_KEY else '–ù–ï–¢'}")
    app.run(host='0.0.0.0', port=port, debug=False)
